## 工程现状概览
- Monorepo：`packages/Flipbook`（库）与`packages/storybook`（演示与测试）
- 构建与工具：Vite + TypeScript + Vitest + Storybook（Vue3-Vite）
- 关键入口：库入口 `packages/Flipbook/src/index.ts`；组件 `packages/Flipbook/src/Flipbook.vue`

## 待修复问题
- TypeScript 断言错误：`app.component(Flipbook.name, ...)` 在 Type 检查中报错，`name`可能为`undefined`（`packages/Flipbook/src/index.ts:5`）
- 测试不通过：`pageUrl`不可访问且语义不一致（测试使用0基下标，库实现以1基为准并在越界时返回空字符串）：
  - 定义处：`packages/Flipbook/src/useImageLoad.ts:29-36`
  - 失败用例：`packages/storybook/src/test/pageUrl.test.js:14,26,39`
- 多余/误导性文件：`packages/Flipbook/src/index.js` 为构建产物样式的旧文件，留在`src`目录会混淆（`packages/Flipbook/src/index.js`）
- 控制台日志噪音：`consola`设为`level: 4`但测试仍输出（`packages/Flipbook/src/Flipbook.vue:129-136`）；应按`NODE_ENV`屏蔽或调低级别
- 仓库信息错误：`packages/Flipbook/package.json:27` 存在 `https://https://` 双协议
- Husky/lint-staged 使用 `bun`（根 `package.json:51-61`）但工程未配置 `bun`，会导致钩子失败

## 优化项（代码与配置）
- 组件命名与安装：在 SFC 中显式 `name`，或在安装时使用回退名，确保 TS 稳定（`packages/Flipbook/src/index.ts:4-7`）
- 页面 URL 语义统一：
  - `pageUrl(page, hiRes?)` 改为0基下标，越界返回 `null`（便于 `v-if` 与测试一致）（`packages/Flipbook/src/useImageLoad.ts:29-36`）
  - `UseImageLoad` 类型签名更新为 `string | null`
  - 所有调用点以真值判断即可兼容（如 `packages/Flipbook/src/Flipbook.vue:244-247, 391`）
  - 对外暴露 `pageUrl` 供测试（`defineExpose`），或将测试改为读取 `setupState.pageUrl`
- 日志与测试：为 `NODE_ENV !== 'test'` 时才打印，或设置 `level: 0`；减少 Vitest 噪音（`packages/Flipbook/src/Flipbook.vue:129-136`）
- 依赖与外部化：
  - 库不应直接依赖 `vue`；改为 `peerDependencies` 并在 Vite `external` 保持不打包（`packages/Flipbook/vite.config.ts:17-21`）
  - `vue-material-design-icons` 仅用于示例，移出库依赖，保留在 storybook
- 移除构建残留：删除 `packages/Flipbook/src/index.js`
- 修正仓库地址与脚本：修正 `repository.url`；将 Husky/lint-staged 脚本改为使用 `pnpm`/`node`

## 依赖升级方案
- 统一包管理使用 `pnpm`，升级至最新稳定：
  - 库：`vite 5.4.x`、`@vitejs/plugin-vue 5.x`、`typescript 5.9.x`、`vue-tsc 2.x`
  - 根工具链：`eslint 9.x`（随配置迁移）、`prettier 3.x`、`stylelint 16.x`
  - Storybook：维持 7.6.x 或评估迁移 8.x（变更较多），当前以 7.6.x 稳定为先
- 生成并更新锁文件，确保一致性

## 测速案例设计（Storybook）
- 新增故事 `FlipPerf`：
  - 通过 `@flip-*` 事件（`packages/Flipbook/src/Flipbook.vue:536-555`）记录翻页开始/结束时间，计算耗时与平均 FPS
  - 使用 `requestAnimationFrame` 统计翻页期间帧数
  - 批量翻页（例如连续翻 50 次）输出：平均耗时、P95、最大/最小帧时间
  - 支持参数化：`nPolygons`、`flipDuration`、`zooms`，用于对比不同配置

## 验证流程
- 安装与构建：`pnpm install` → `pnpm -C packages/Flipbook build`
- 测试：`pnpm -C packages/storybook test -- --run`（修复后应全部通过）
- 运行演示：`pnpm -C packages/storybook storybook` 并在故事中查看翻页、缩放与测速输出

## 交付步骤
1) 修复 TS 安装错误与 `pageUrl` 语义/暴露方式；删除残留文件
2) 调整日志与脚本；修正仓库地址
3) 梳理依赖（peerDependencies 与 devDependencies），升级并锁定
4) 添加 Storybook 测速故事，输出指标
5) 全量构建与测试通过，提交变更说明（不自动提交）